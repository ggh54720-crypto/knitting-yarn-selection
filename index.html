<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‰‹æ··ç·šé…è‰²</title>
<style>
body { font-family:sans-serif; background:#f5f1ea; padding:16px; }
.app { max-width:800px; width:100%; margin:auto; background:#fff; border-radius:20px; padding:16px; }
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }

.yarns { display:grid; grid-template-columns:repeat(auto-fit, minmax(100px,1fr)); gap:12px; margin-top:12px; }
.yarn { border:2px solid #eee; border-radius:12px; padding:6px; text-align:center; position:relative; cursor:pointer; transition: all 0.2s; }
.yarn:hover { transform: scale(1.05); }
.yarn.selected { border-color:#ff8f66; }
.yarn img { width:100%; border-radius:8px; }

.number-box {
  position:absolute;
  top:4px;
  left:4px;
  width:20px;
  height:20px;
  border-radius:4px;
  background:#ff8f66;
  color:#fff;
  font-size:12px;
  text-align:center;
  line-height:20px;
  display:none;
}

button { padding:10px 14px; border-radius:12px; border:none; font-size:16px; cursor:pointer; transition: all 0.2s; }
button:hover { opacity:0.8; }
.primary { background:#ff8f66; color:#fff; }
.secondary { background:#444; color:#fff; }

#previewContainer {
  margin-top:20px;
  border-top:1px solid #ddd;
  padding-top:12px;
  text-align:center;
  opacity:0;
  transform: translateY(20px);
  transition: all 0.3s;
  display:none;
}
#previewContainer.show { opacity:1; transform: translateY(0); display:block; }

#previewContainer img { width:80px; height:80px; border-radius:8px; margin:0 4px; }

#toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background:#444;
  color:#fff;
  padding:12px 20px;
  border-radius:12px;
  opacity:0;
  transition: opacity 0.5s;
  z-index:1000;
}
</style>
</head>
<body>
<div class="app">
<header>
  <h3>ğŸ§¶ æ‰‹æ··ç·š</h3>
  <button type="button" id="cartBtn" onclick="showCart()">ğŸ›’ 0</button>
</header>

<div id="home">
  <input id="search" placeholder="æœå°‹ç·šææˆ–é¡è‰²"
    oninput="filterYarns()"
    style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;">

  <div class="yarns">
    <label class="yarn" data-name="å¥¶èŒ¶ç‡•éº¥">
      <div class="number-box"></div>
      <input type="checkbox" value="A">
      <img src="images/A.jpg">
      <div>å¥¶èŒ¶ç‡•éº¥</div>
    </label>

    <label class="yarn" data-name="éœ§è—æµ·é¹½">
      <div class="number-box"></div>
      <input type="checkbox" value="B">
      <img src="images/B.jpg">
      <div>éœ§è—æµ·é¹½</div>
    </label>

    <label class="yarn" data-name="æ£®æ—æ©„æ¬–">
      <div class="number-box"></div>
      <input type="checkbox" value="C">
      <img src="images/C.jpg">
      <div>æ£®æ—æ©„æ¬–</div>
    </label>

    <label class="yarn" data-name="å¤•é™½æ©˜">
      <div class="number-box"></div>
      <input type="checkbox" value="D">
      <img src="images/D.jpg">
      <div>å¤•é™½æ©˜</div>
    </label>

    <label class="yarn" data-name="ç²‰ç´…æ«»èŠ±">
      <div class="number-box"></div>
      <input type="checkbox" value="E">
      <img src="images/E.jpg">
      <div>ç²‰ç´…æ«»èŠ±</div>
    </label>

    <label class="yarn" data-name="å¤©ç©ºè—">
      <div class="number-box"></div>
      <input type="checkbox" value="F">
      <img src="images/F.jpg">
      <div>å¤©ç©ºè—</div>
    </label>
  </div>
</div>

<div id="previewContainer">
  <p id="mixInfo">æ··ç·šé è¦½</p>
  <div id="previewSlider"></div>
  <button type="button" class="primary" onclick="addToCart()">åŠ å…¥è³¼ç‰©è»Š</button>
  <button type="button" class="secondary" onclick="cancelPreview()">å–æ¶ˆé è¦½</button>
</div>

<div id="toast"></div>
</div>

<script>
let selectionOrder = [];
let currentSelected = [];
let savedSelection = [];
let currentKey = "";

// Toast æç¤º
function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.style.opacity=1;
  setTimeout(()=>t.style.opacity=0,1500);
}

// æœå°‹éæ¿¾
function filterYarns(){
  const k = document.getElementById("search").value.toLowerCase() || "";
  document.querySelectorAll(".yarn").forEach(y=>{
    y.style.display = y.dataset.name.toLowerCase().includes(k) ? "block":"none";
  });
}

// å‹¾é¸é‚è¼¯
document.querySelectorAll(".yarn input").forEach(inp=>{
  inp.addEventListener("change", ()=>{
    const parent = inp.closest(".yarn");
    const numberBox = parent.querySelector(".number-box");

    if(inp.checked){
      if(selectionOrder.length>=6){
        inp.checked=false;
        showToast("æœ€å¤šåªèƒ½é¸6çµ„ç·šæ");
        return;
      }
      selectionOrder.push(inp.value);
      numberBox.innerText = selectionOrder.indexOf(inp.value)+1;
      numberBox.style.display="block";
      parent.classList.add("selected");
    } else {
      const idx = selectionOrder.indexOf(inp.value);
      if(idx>-1) selectionOrder.splice(idx,1);
      numberBox.style.display="none";
      parent.classList.remove("selected");
      // é‡æ–°æ’åˆ—å…¶ä»–é¸é …ç·¨è™Ÿ
      document.querySelectorAll(".yarn input:checked").forEach(i=>{
        const box = i.closest(".yarn").querySelector(".number-box");
        box.innerText = selectionOrder.indexOf(i.value)+1;
      });
    }
    updatePreview();
  });
});

// æ›´æ–°ä¸‹æ–¹æ··ç·šé è¦½
function updatePreview(){
  const preview=document.getElementById("previewSlider");
  preview.innerHTML="";
  if(selectionOrder.length===0) return;
  selectionOrder.forEach(v=>{
    const img=document.createElement("img");
    img.src=`images/${v}.jpg`;
    img.alt = v;
    img.onerror=()=>img.src="images/placeholder.jpg";
    preview.appendChild(img);
  });
  currentKey = "MIX-" + selectionOrder.join("-");
  document.getElementById("mixInfo").innerText = currentKey;

  const previewContainer = document.getElementById("previewContainer");
  previewContainer.style.display="block";
  setTimeout(()=>previewContainer.classList.add("show"),50);
}

// å–æ¶ˆé è¦½
function cancelPreview(){
  const preview = document.getElementById("previewContainer");
  preview.classList.remove("show");
  preview.addEventListener('transitionend', e=>{
    if(e.target===preview) preview.style.display="none";
  }, {once:true});

  // æ¢å¾©é¸æ“‡ç‹€æ…‹
  selectionOrder = [...savedSelection];
  document.querySelectorAll(".yarn input").forEach(i=>{
    i.checked = selectionOrder.includes(i.value);
    i.closest(".yarn").classList.toggle("selected", i.checked);
    const box = i.closest(".yarn").querySelector(".number-box");
    if(i.checked){
      box.style.display="block";
      box.innerText = selectionOrder.indexOf(i.value)+1;
    } else {
      box.style.display="none";
    }
  });
}

// åŠ å…¥è³¼ç‰©è»Š
function addToCart(){
  if(selectionOrder.length===0){ showToast("è«‹å…ˆé¸æ“‡ç·šæ"); return; }
  const cart=JSON.parse(localStorage.getItem("cart")||"[]");
  const key="MIX-"+selectionOrder.join("-");
  if(!cart.some(item=>item.key===key)){
    cart.push({key:key, combo:[...selectionOrder], timestamp:Date.now()});
  }
  localStorage.setItem("cart",JSON.stringify(cart));
  showToast("å·²åŠ å…¥è³¼ç‰©è»Š");
  updateCartCount();

  // æ¸…ç©ºé¸æ“‡
  selectionOrder=[];
  document.querySelectorAll(".yarn input").forEach(i=>i.checked=false);
  document.querySelectorAll(".number-box").forEach(b=>b.style.display="none");
  document.querySelectorAll(".yarn").forEach(y=>y.classList.remove("selected"));
  updatePreview();
}

// æ›´æ–°è³¼ç‰©è»Šæ•¸é‡
function updateCartCount(){
  const cartData=JSON.parse(localStorage.getItem("cart")||"[]");
  document.getElementById("cartBtn").innerText=`ğŸ›’ ${cartData.length}`;
}

updateCartCount();
</script>
</body>
</html>
