// 計算所有組合
function getAllCombos(selected){
  const combos = [];
  const n = selected.length;
  for(let k=1; k<=n; k++){
    combine(selected, k, [], combos);
  }
  return combos;
}

// 遞迴生成組合
function combine(arr, k, path, combos){
  if(path.length === k){ combos.push([...path].sort()); return; }
  for(let i=0;i<arr.length;i++){
    path.push(arr[i]);
    combine(arr.slice(i+1), k, path, combos);
    path.pop();
  }
}

// 顯示下方多縮圖預覽
function showPreview() {
  const selected = [...document.querySelectorAll("#home input:checked")].map(i=>i.value).sort();
  if(!selected.length){ showToast("請至少選一種線材"); return; }

  currentSelected = [...selected];
  savedSelection = [...selected];

  const combos = getAllCombos(selected);

  const slider = document.getElementById("previewSlider");
  slider.innerHTML="";

  combos.forEach((combo,i)=>{
    const img = document.createElement("img");
    const key = "MIX-"+combo.join("-");
    img.src=`images/mix/${combo.join("-")}.jpg`;
    img.onerror=()=>{ img.src="images/placeholder.jpg"; };
    if(i===0){ img.classList.add("selected"); currentKey=key; }
    img.addEventListener("click", ()=>{
      document.querySelectorAll("#previewSlider img").forEach(im=>im.classList.remove("selected"));
      img.classList.add("selected");
      currentSelected = combo;
      currentKey = key;
      document.getElementById("mixInfo").innerText=currentKey;
    });
    slider.appendChild(img);
  });

  document.getElementById("mixInfo").innerText=currentKey;

  // 高亮勾選線材
  document.querySelectorAll(".yarn").forEach(y=>{
    const input = y.querySelector("input");
    if(input.checked) y.classList.add("selected");
    else y.classList.remove("selected");
  });

  const preview = document.getElementById("previewContainer");
  preview.classList.remove("hidden");
  setTimeout(()=>preview.classList.add("show"),50);
}
