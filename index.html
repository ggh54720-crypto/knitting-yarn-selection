<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‰‹æ··ç·šé…è‰²</title>

<style>
body { font-family:sans-serif; background:#f5f1ea; padding:16px; }
.app { max-width:420px; margin:auto; background:#fff; border-radius:20px; padding:16px; }
header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }

.yarns { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:12px; }
.yarn { border:2px solid #eee; border-radius:12px; padding:6px; text-align:center; transition: transform 0.2s, border 0.2s; }
.yarn:hover { transform: scale(1.05); }
.yarn.selected { border-color:#ff8f66; }
.yarn img { width:100%; border-radius:8px; }

button { width:100%; padding:14px; border-radius:12px; border:none; margin-top:12px; font-size:16px; cursor:pointer; transition:all 0.2s; }
button:hover { opacity:0.8; }
.primary { background:#ff8f66; color:#fff; }
.secondary { background:#444; color:#fff; }

.hidden { display:none; }

.card { border:1px solid #ddd; border-radius:14px; padding:10px; margin-bottom:12px; }
.card img { width:100%; border-radius:10px; }

.row { display:flex; align-items:center; gap:6px; }
.row strong { flex:1; }

#toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background:#444;
  color:#fff;
  padding:12px 20px;
  border-radius:12px;
  opacity:0;
  transition: opacity 0.5s;
  z-index:1000;
}

#previewContainer { margin-top:20px; text-align:center; }
#previewContainer img { max-width:100%; border-radius:12px; }
</style>
</head>

<body>
<div class="app">

<header>
  <h3>ğŸ§¶ æ‰‹æ··ç·š</h3>
  <button type="button" id="cartBtn" onclick="showCart()">ğŸ›’ 0</button>
</header>

<div id="home">
  <input id="search" placeholder="æœå°‹ç·šæ"
    oninput="filterYarns()"
    style="width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;">

  <div class="yarns">
    <label class="yarn" data-name="å¥¶èŒ¶ç‡•éº¥">
      <input type="checkbox" value="A">
      <img src="images/A.jpg">
      <div>å¥¶èŒ¶ç‡•éº¥</div>
    </label>

    <label class="yarn" data-name="éœ§è—æµ·é¹½">
      <input type="checkbox" value="B">
      <img src="images/B.jpg">
      <div>éœ§è—æµ·é¹½</div>
    </label>

    <label class="yarn" data-name="æ£®æ—æ©„æ¬–">
      <input type="checkbox" value="C">
      <img src="images/C.jpg">
      <div>æ£®æ—æ©„æ¬–</div>
    </label>
  </div>

  <button type="button" class="primary" onclick="makePreview()">ç”¢ç”Ÿæ··ç·šé è¦½</button>
</div>

<div id="previewContainer" class="hidden">
  <img id="mixImg">
  <p id="mixInfo"></p>
  <button type="button" class="primary" onclick="addToCart()">åŠ å…¥è³¼ç‰©è»Š</button>
  <button type="button" class="secondary" onclick="cancelPreview()">å–æ¶ˆ</button>
</div>

<div id="cart" class="hidden">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
    <h3>è³¼ç‰©è»Š</h3>
    <div>
      <button class="secondary" onclick="backHome()">å›é¦–é </button>
      <button class="secondary" onclick="clearCart()">æ¸…ç©ºè³¼ç‰©è»Š</button>
      <button class="secondary" onclick="deleteSelected()">åˆªé™¤é¸å–</button>
    </div>
  </div>
  <div id="cartList"></div>
</div>

<div id="toast"></div>
</div>

<script>
let currentKey="", currentSelected=[], savedSelection=[];

function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.style.opacity=1;
  setTimeout(()=>t.style.opacity=0,1500);
}

function filterYarns(){
  const k=search.value.toLowerCase();
  document.querySelectorAll(".yarn").forEach(y=>{
    y.style.display=y.dataset.name.toLowerCase().includes(k)?"block":"none";
  });
}

function makePreview(){
  const selected=[...document.querySelectorAll("#home input:checked")].map(i=>i.value).sort();
  if(!selected.length){ showToast("è«‹è‡³å°‘é¸ä¸€ç¨®ç·šæ"); return; }
  currentSelected=[...selected];
  savedSelection=[...selected];
  currentKey="MIX-"+selected.join("-");
  mixImg.src=`images/mix/${selected.join("-")}.jpg`;
  mixInfo.innerText=currentKey;
  document.getElementById("home").classList.add("hidden");
  document.getElementById("previewContainer").classList.remove("hidden");
}

function cancelPreview(){
  document.getElementById("previewContainer").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
}

function addToCart(){
  const cart=JSON.parse(localStorage.getItem("cart")||"[]");
  cart.push({key:currentKey, combo:[...currentSelected], timestamp:Date.now()});
  localStorage.setItem("cart",JSON.stringify(cart));
  showToast("å·²åŠ å…¥è³¼ç‰©è»Š");
  updateCartCount();
  document.querySelectorAll("#home input[type=checkbox]").forEach(c=>c.checked=false);
  currentSelected=[];
  currentKey="";
  document.querySelectorAll(".yarn").forEach(y=>y.classList.remove("selected"));
  cancelPreview();
}

document.querySelectorAll(".yarn input").forEach(inp=>{
  inp.addEventListener("change",()=>inp.checked?inp.closest(".yarn").classList.add("selected"):inp.closest(".yarn").classList.remove("selected"));
});

function updateCartCount(){
  const cartData=JSON.parse(localStorage.getItem("cart")||"[]");
  document.getElementById("cartBtn").innerText=`ğŸ›’ ${cartData.length}`;
}

function showCart(){
  document.getElementById("home").classList.add("hidden");
  document.getElementById("previewContainer").classList.add("hidden");
  document.getElementById("cart").classList.remove("hidden");
  renderCart();
}

function backHome(){
  document.getElementById("home").classList.remove("hidden");
  document.getElementById("previewContainer").classList.add("hidden");
  document.getElementById("cart").classList.add("hidden");
}

function renderCart(){
  const cartData=JSON.parse(localStorage.getItem("cart")||"[]").sort((a,b)=>b.timestamp-a.timestamp);
  const cartList=document.getElementById("cartList");
  cartList.innerHTML="";
  cartData.forEach((item,i)=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <div class="row">
        <input type="checkbox" data-index="${i}">
        <strong>${item.key}</strong>
        <button type="button" onclick="copyCode('${item.key}')">ğŸ“‹</button>
      </div>
      <img src="images/mix/${item.combo.join("-")}.jpg" onerror="this.src='images/placeholder.jpg'">
      <button type="button" onclick="edit(${i})">ä¿®æ”¹é…è‰²</button>
    `;
    cartList.appendChild(div);
  });
}

function copyCode(text){ navigator.clipboard.writeText(text); showToast("å·²è¤‡è£½ä»£ç¢¼ï¼š"+text); }

function edit(index){
  const cart=JSON.parse(localStorage.getItem("cart")||"[]");
  const item=cart[index];
  document.querySelectorAll("#home input[type=checkbox]").forEach(c=>c.checked=false);
  item.combo.forEach(v=>document.querySelector(`#home input[value="${v}"]`).checked=true);
  backHome();
}

function clearCart(){
  if(confirm("ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ")){
    localStorage.removeItem("cart");
    renderCart();
    updateCartCount();
    showToast("è³¼ç‰©è»Šå·²æ¸…ç©º");
  }
}

function deleteSelected(){
  const cart=JSON.parse(localStorage.getItem("cart")||"[]");
  const checked=[...document.querySelectorAll("#cartList input[type=checkbox]:checked")].map(c=>parseInt(c.dataset.index));
  if(!checked.length){ showToast("è«‹é¸æ“‡è¦åˆªé™¤çš„é …ç›®"); return; }
  const newCart=cart.filter((_,i)=>!checked.includes(i));
  localStorage.setItem("cart",JSON.stringify(newCart));
  renderCart();
  updateCartCount();
  showToast("å·²åˆªé™¤é¸å–é …ç›®");
}

updateCartCount();
</script>
</body>
</html>
