<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‰‹æ··ç·š</title>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #fafafa;
  padding-bottom: 35vh;
}

.app {
  max-width: 900px;
  margin: auto;
  padding: 16px;
}

/* ===== ç·šæåˆ—è¡¨ ===== */
.yarns {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
  gap: 12px;
}

.yarn {
  border: 2px solid #eee;
  border-radius: 12px;
  padding: 6px;
  text-align: center;
  position: relative;
  cursor: pointer;
  transition: .2s;
}

.yarn.selected { border-color: #ff8f66; }

.yarn img {
  width: 100%;
  border-radius: 8px;
}

.number-box {
  position: absolute;
  top: 4px;
  left: 4px;
  width: 22px;
  height: 22px;
  background: #ff8f66;
  color: #fff;
  border-radius: 6px;
  font-size: 12px;
  line-height: 22px;
  display: none;
}

/* ç¼ºè²¨æ¨£å¼ */
.yarn.soldout {
  opacity: .4;
  pointer-events: none;
}
.yarn.soldout::after {
  content: "ç¼ºè²¨";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.5);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
}

/* ===== åº•éƒ¨ç°è‰²å€ ===== */
#bottomPanel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 33vh;
  background: #eee;
  box-shadow: 0 -4px 12px rgba(0,0,0,.1);
  display: flex;
  flex-direction: column;
  padding: 12px;
  z-index: 100;
}

/* 6 å€‹é¸ç·šæ ¼ */
#slotRow {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  margin-bottom: 10px;
}

.slot {
  background: #fff;
  border-radius: 10px;
  border: 2px dashed #ccc;
  height: 80px;
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

.slot img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.slot span {
  position: absolute;
  top: 4px;
  left: 4px;
  background: #ff8f66;
  color: #fff;
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 6px;
}

/* MIX é è¦½ */
#mixPreview {
  flex: 1;
  background: #fff;
  border-radius: 14px;
  border: 2px solid #ddd;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#mixPreview img {
  width: 160px;
  height: 160px;
  object-fit: cover;
  border-radius: 12px;
  margin-bottom: 10px;
}

/* æŒ‰éˆ• */
#addCartBtn {
  background: #ff8f66;
  color: #fff;
  border: none;
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 16px;
  cursor: pointer;
}

/* Toast */
#toast {
  position: fixed;
  bottom: 40vh;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: #fff;
  padding: 10px 20px;
  border-radius: 10px;
  opacity: 0;
  transition: .3s;
}
</style>
</head>

<body>

<div class="app">
  <h3>ğŸ§¶ æ‰‹æ··ç·š</h3>

  <div class="yarns">
    <label class="yarn"><div class="number-box"></div><input hidden type="checkbox" value="A"><img src="images/A.jpg"><div>å¥¶èŒ¶ç‡•éº¥</div></label>
    <label class="yarn"><div class="number-box"></div><input hidden type="checkbox" value="B"><img src="images/B.jpg"><div>éœ§è—æµ·é¹½</div></label>
    <label class="yarn"><div class="number-box"></div><input hidden type="checkbox" value="C"><img src="images/C.jpg"><div>æ£®æ—æ©„æ¬–</div></label>
    <label class="yarn"><div class="number-box"></div><input hidden type="checkbox" value="D"><img src="images/D.jpg"><div>å¤•é™½æ©˜</div></label>
    <label class="yarn"><div class="number-box"></div><input hidden type="checkbox" value="E"><img src="images/E.jpg"><div>ç²‰ç´…æ«»èŠ±</div></label>
    <label class="yarn"><div class="number-box"></div><input hidden type="checkbox" value="F"><img src="images/F.jpg"><div>å¤©ç©ºè—</div></label>
  </div>
</div>

<div id="bottomPanel">
  <div id="slotRow">
    <div class="slot"></div><div class="slot"></div><div class="slot"></div>
    <div class="slot"></div><div class="slot"></div><div class="slot"></div>
  </div>

  <div id="mixPreview">
    <img id="mixImg" src="images/placeholder.jpg">
    <button id="addCartBtn">åŠ å…¥è³¼ç‰©è»Š</button>
  </div>
</div>

<div id="toast"></div>

<script>
let selected = [];
let stockData = {};

/* Toast */
function showToast(msg){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.opacity = 1;
  setTimeout(()=>t.style.opacity=0,1500);
}

/* ç·šæé»æ“Š */
document.querySelectorAll(".yarn").forEach(y=>{
  y.addEventListener("click", ()=>{
    const input = y.querySelector("input");
    if(y.classList.contains("soldout")) return;

    if(!input.checked && selected.length >= 6){
      showToast("æœ€å¤šåªèƒ½é¸ 6 ç¨®ç·šæ");
      return;
    }
    input.checked = !input.checked;
    updateSelection();
  });
});

/* æ›´æ–°é¸æ“‡ */
function updateSelection(){
  selected = [...document.querySelectorAll(".yarn input:checked")].map(i=>i.value);

  document.querySelectorAll(".yarn").forEach(y=>{
    const i = y.querySelector("input");
    const box = y.querySelector(".number-box");
    if(i.checked){
      y.classList.add("selected");
      box.style.display="block";
      box.innerText = selected.indexOf(i.value)+1;
    } else {
      y.classList.remove("selected");
      box.style.display="none";
    }
  });

  document.querySelectorAll(".slot").forEach((s,i)=>{
    s.innerHTML="";
    if(selected[i]){
      const img=document.createElement("img");
      img.src=`images/${selected[i]}.jpg`;
      const tag=document.createElement("span");
      tag.innerText=i+1;
      s.append(img,tag);
      s.onclick=()=>{
        document.querySelector(`input[value="${selected[i]}"]`).checked=false;
        updateSelection();
      };
    }
  });

  updateMixPreview();
}

/* MIX åœ– */
function updateMixPreview(){
  const img=document.getElementById("mixImg");
  if(!selected.length){
    img.src="images/placeholder.jpg";
    return;
  }
  const path=`images/mix/${selected.join("-")}.jpg`;
  const t=new Image();
  t.onload=()=>img.src=path;
  t.onerror=()=>img.src=`images/${selected[0]}.jpg`;
  t.src=path;
}

/* åº«å­˜å³æ™‚æ›´æ–° */
async function fetchStock(){
  try{
    const res=await fetch("stock.json?_="+Date.now());
    stockData=await res.json();

    document.querySelectorAll(".yarn").forEach(y=>{
      const val=y.querySelector("input").value;
      if(stockData[val]===false){
        y.classList.add("soldout");
        y.querySelector("input").checked=false;
      } else {
        y.classList.remove("soldout");
      }
    });
    updateSelection();
  }catch(e){
    console.warn("åº«å­˜è®€å–å¤±æ•—");
  }
}
setInterval(fetchStock,15000);
fetchStock();

/* åŠ å…¥è³¼ç‰©è»Š */
document.getElementById("addCartBtn").onclick=async()=>{
  if(!selected.length){
    showToast("è«‹å…ˆé¸æ“‡ç·šæ");
    return;
  }
  for(const v of selected){
    if(stockData[v]===false){
      showToast("æœ‰ç·šæå·²å”®å®Œï¼Œè«‹é‡æ–°é¸æ“‡");
      fetchStock();
      return;
    }
  }
  const cart=JSON.parse(localStorage.getItem("cart")||"[]");
  cart.push({key:"MIX-"+selected.join("-"),combo:[...selected]});
  localStorage.setItem("cart",JSON.stringify(cart));
  showToast("å·²åŠ å…¥è³¼ç‰©è»Š");
  document.querySelectorAll(".yarn input").forEach(i=>i.checked=false);
  updateSelection();
};
</script>
</body>
</html>
